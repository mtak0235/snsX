<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
        .pageTitle {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 52px;
            line-height: 52px;
            color: #fff;
            text-align: center;
            background: #111;
        }
        article {
            padding: 52px 3% 0;
        }
        article .block {
            padding: 20px;
            min-height: 500px;
        }
        article .block p {
            line-height: 22px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }
        article .block:nth-child(2n + 1) {
            background: #999;
        }
        article .block:nth-child(2n) {
            background: #222;
        }
    </style>
</head>

<body>
<header>
    <h1 class="pageTitle">Infinity scroll</h1>
</header>
<article id="article">
    <div class="block">
        <p>
            Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptatem
            mollitia accusamus sequi ipsa, rerum nam laboriosam, ipsam aperiam
            deleniti beatae expedita id quisquam veritatis corporis, voluptates
            ducimus molestiae eum adipisci.
        </p>
    </div>
    <div class="block">
        <p>
            Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptatem
            mollitia accusamus sequi ipsa, rerum nam laboriosam, ipsam aperiam
            deleniti beatae expedita id quisquam veritatis corporis, voluptates
            ducimus molestiae eum adipisci.
        </p>
    </div>
    ... 반복
</article>
</body>
<script  th:inline="javascript">
    /*<![CDATA[*/
    //Javascript
    const innerHeight = window.innerHeight;
    // 사용자에게 보여지고 있는 브라우저의 높이

    const scrollHeight = window.scrollY;
    // 현재 스크롤 위치

    const bodyHeight = document.body.offsetHeight;
    //전체 브라우저의 실질적인 높이

    // index.js
    var count = 0;
    const scrolling = async (e) => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
            count++;
            const content = document.createElement("div");
            const data = await fetch(
                `https://api.themoviedb.org/3/movie/now_playing?api_key=api_key&language=ko-KR&page=${count}`
            )
                .then((res) => res.json())
                .then((Json) => Json.results);
            const addContent = '<div class="block"><p>' + data[0].title + "</p></div>";

            content.innerHTML = addContent;
            const article = document.getElementById("article");
            article.appendChild(content);
        }
    };
    window.onscroll = scrolling;
    const lazyloading = () => {
        const lazyloadImages = document.querySelectorAll("img.lazy");

        let lazyloadThrottleTimeout;
        const lazyload = () => {
            if (lazyloadThrottleTimeout) {
                clearTimeout(lazyloadThrottleTimeout);
            }
            lazyloadThrottleTimeout = setTimeout(() => {
                const scrollTop = window.scrollY;
                lazyloadImages.forEach((img) => {
                    if (img.offsetTop < window.innerHeight + scrollTop) {
                        // img.offsetTop: 실질적으로 img가 위치한 높이
                        img.src = img.dataset.src;
                        img.classList.remove("lazy");
                    }
                });
                if (lazyloadImages.length == 0) {
                    document.removeEventListener("scroll", lazyload);
                    window.removeEventListener("resize", lazyload);
                    window.removeEventListener("orientationChange", lazyload);
                }
            }, 20);
        };
        document.addEventListener("scroll", lazyload);
        window.addEventListener("resize", lazyload);
        window.addEventListener("orientationChange", lazyload);
    };
    document.addEventListener("DOMContentLoaded", lazyloading);
    // onscroll와 콜백함수를 등록한다.

// function getPageId(n) {
//     return 'article-page-' + n;
// }
//
// function getDocumentHeight() {
//     const body = document.body;
//     const html = document.documentElement;
//     return Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
// }
//
// function getScrollTop() {
//     return window.pageYOffset !== undefined ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop;
// }
//
// function getArticleImage() {
//     const hash = Math.floor(Math.random() * Number.MAX_SAFE_INTEGER);
//     const image = new Image();
//     image.className = 'article-list__item__image article-list__item__image--loading';
//     image.src = 'https://stock.adobe.com/kr/search/free?filters%5Bcontent_type%3Aphoto%5D=1&filters%5Bcontent_type%3Aillustration%5D=0&filters%5Bcontent_type%3Azip_vector%5D=0&filters%5Bcontent_type%3Avideo%5D=0&filters%5Bcontent_type%3Atemplate%5D=0&filters%5Bcontent_type%3A3d%5D=0&filters%5Binclude_stock_enterprise%5D=0&filters%5Bis_editorial%5D=0&filters%5Bfree_collection%5D=1&filters%5Bcontent_type%3Aimage%5D=1&order=relevance&safe_search=1&search_type=filter-select&get_facets=1&asset_id=' + hash;
//     image.onload = function () {
//         image.classList.remove('article-list__item__image--loading');
//     };
//     return image;
// }
//
// function getArticle() {
//     const articleImage = getArticleImage();
//     const article = document.createElement('article');
//     article.className = 'article-list__item';
//     article.appendChild(articleImage);
//     return article;
// }
//
// function getArticlePage(page, articlesPerPage = 10) {
//     const pageElement = document.createElement('div');
//     pageElement.id = getPageId(page);
//     pageElement.className = 'article-list__page';
//     while (articlesPerPage--) {
//         pageElement.appendChild(getArticle());
//     }
//     return pageElement;
// }
//
// function addPaginationPage(page) {
//     const pageLink = document.createElement('a');
//     pageLink.href = '#' + getPageId(page);
//     pageLink.innerHTML = page;
//     const listItem = document.createElement('li');
//     listItem.className = 'article-list__pagination__item';
//     listItem.appendChild(pageLink);
//     articleListPagination.appendChild(listItem);
//     if (page === 2) {
//         articleListPagination.classList.remove('article-list__pagination--inactive');
//     }
// }
//
// function fetchPage(page) {
//     articleList.appendChild(getArticlePage(page));
// }
//
// function addPage(page) {
//     fetchPage(page); // add articleList data
//     addPaginationPage(page); // add articleListPagination data
//     }
//     const articleList = document.getElementById('article-list');
//     const articleListPagination = document.getElementById( 'article-list-pagination' );
//     let page = 0; // 초기 페이지 로드
//     addPage(++page);
//     window.onscroll = function () { if (getScrollTop() < getDocumentHeight() - window.innerHeight) return; // 스크롤이 페이지 하단에 도달할 경우 새 페이지 로드
//     addPage(++page); };
    /*]]>*/
</script>
</body>
</html>
